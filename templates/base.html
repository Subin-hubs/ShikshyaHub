<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}ShikshyaHub{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  {% block extra_css %}{% endblock %}
</head>
<body>

<div class="portal-layout">
  <!-- â”€â”€ SIDEBAR â”€â”€ -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">S</div>
      <div>
        <div class="logo-text">Shikshya<span>Hub</span></div>
        <div class="logo-sub">{% block role_label %}Portal{% endblock %}</div>
      </div>
    </div>
    <div class="sidebar-user">
      <div class="avatar">{{ session.name[0].upper() }}</div>
      <div style="overflow:hidden;">
        <div class="user-name">{{ session.name }}</div>
        <div class="user-role">{{ session.role.title() }}</div>
      </div>
    </div>
    <nav class="sidebar-nav">
      {% block sidebar_nav %}{% endblock %}
    </nav>
    <div class="sidebar-footer">
      <a href="{{ url_for('logout') }}">
        <span style="font-size:1rem;">ğŸšª</span> Sign Out
      </a>
    </div>
  </aside>

  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- â”€â”€ MAIN â”€â”€ -->
  <div class="main-content">

    <!-- Topbar -->
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:12px;">
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Menu">â˜°</button>
        <span class="topbar-title">{% block page_title %}Dashboard{% endblock %}</span>
      </div>

      <div class="topbar-right" style="position:relative;">
        <span id="topbarClock"></span>

        <!-- Dark/Light toggle -->
        <button class="theme-toggle" id="themeToggle" title="Toggle dark/light mode" aria-label="Toggle theme">
          <span id="themeIcon">ğŸŒ™</span>
        </button>

        <!-- Notifications -->
        <div style="position:relative;">
          <button class="notif-btn" id="notifBtn" title="Notifications" aria-label="Notifications">
            ğŸ””
            <div class="notif-count" id="notifCount" {% if not notif_count %}style="display:none;"{% endif %}>
              {{ notif_count if notif_count < 100 else '99+' }}
            </div>
          </button>

          <div class="notif-dropdown" id="notifDropdown">
            <div class="notif-header">
              <span class="notif-header-title">ğŸ”” Notifications</span>
              <button class="btn btn-xs btn-outline" onclick="markAllRead()">Mark all read</button>
            </div>
            <!-- Type badges -->
            {% if notif_by_type %}
            <div style="padding:8px 16px;display:flex;flex-wrap:wrap;gap:6px;border-bottom:1px solid var(--border);">
              {% if notif_by_type.get('notice') %}<span class="badge badge-info">ğŸ“¢ {{ notif_by_type['notice'] }} notice{{ 's' if notif_by_type['notice'] != 1 }}</span>{% endif %}
              {% if notif_by_type.get('assignment') %}<span class="badge badge-warning">ğŸ“ {{ notif_by_type['assignment'] }} assignment{{ 's' if notif_by_type['assignment'] != 1 }}</span>{% endif %}
              {% if notif_by_type.get('fee') %}<span class="badge badge-success">ğŸ’° {{ notif_by_type['fee'] }} fee alert{{ 's' if notif_by_type['fee'] != 1 }}</span>{% endif %}
              {% if notif_by_type.get('result') %}<span class="badge badge-gold">ğŸ“Š {{ notif_by_type['result'] }} result{{ 's' if notif_by_type['result'] != 1 }}</span>{% endif %}
              {% if notif_by_type.get('grade') %}<span class="badge badge-navy">âœï¸ {{ notif_by_type['grade'] }} grade{{ 's' if notif_by_type['grade'] != 1 }}</span>{% endif %}
            </div>
            {% endif %}
            <div id="notifList">
              <div style="padding:24px;text-align:center;color:var(--text-light);font-size:.82rem;">Loadingâ€¦</div>
            </div>
          </div>
        </div>

        <!-- User chip -->
        <div class="topbar-user">
          <div class="topbar-avatar">{{ session.name[0].upper() }}</div>
          <span class="topbar-name">{{ session.name.split()[0] }}</span>
        </div>
      </div>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container">
          {% for cat, msg in messages %}
            <div class="flash flash-{{ cat if cat in ['success','error','info'] else 'info' }}">
              {{ 'âœ“' if cat=='success' else 'âœ•' if cat=='error' else 'â„¹' }}
              {{ msg }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="page-content">
      {% block content %}{% endblock %}
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script>
/* â”€â”€ Dark Mode â”€â”€ */
(function(){
  const saved = localStorage.getItem('shikshyahub-theme') || 'light';
  document.documentElement.setAttribute('data-theme', saved);
  document.getElementById('themeIcon').textContent = saved === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
})();

document.getElementById('themeToggle').addEventListener('click', function() {
  const html = document.documentElement;
  const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('shikshyahub-theme', next);
  document.getElementById('themeIcon').textContent = next === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
  showToast(next === 'dark' ? 'ğŸŒ™ Dark mode on' : 'â˜€ï¸ Light mode on');
});

/* â”€â”€ Notification dropdown â”€â”€ */
const notifBtn      = document.getElementById('notifBtn');
const notifDropdown = document.getElementById('notifDropdown');
let notifLoaded     = false;

notifBtn.addEventListener('click', function(e) {
  e.stopPropagation();
  notifDropdown.classList.toggle('open');
  if (notifDropdown.classList.contains('open') && !notifLoaded) {
    loadNotifications();
    notifLoaded = true;
  }
});
document.addEventListener('click', function(e) {
  if (!notifDropdown.contains(e.target) && e.target !== notifBtn) {
    notifDropdown.classList.remove('open');
  }
});

function loadNotifications() {
  fetch('/api/notifications')
    .then(r => r.json())
    .then(data => {
      const list  = document.getElementById('notifList');
      const count = document.getElementById('notifCount');
      if (data.count > 0) {
        count.textContent = data.count > 99 ? '99+' : data.count;
        count.style.display = 'flex';
      } else {
        count.style.display = 'none';
      }
      if (!data.items || data.items.length === 0) {
        list.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-light);font-size:.82rem;">No notifications</div>';
        return;
      }
      list.innerHTML = data.items.map(n => `
        <a href="${n.link || '#'}" class="notif-item ${n.is_read ? '' : 'unread'}" style="display:block;text-decoration:none;">
          <div class="notif-item-title">${escHtml(n.title)}</div>
          <div class="notif-item-msg">${escHtml(n.message || '')}</div>
          <div class="notif-item-time">${n.created_at ? n.created_at.substring(0,16) : ''}</div>
        </a>`).join('');
    }).catch(() => {
      document.getElementById('notifList').innerHTML =
        '<div style="padding:16px;color:var(--text-light);font-size:.82rem;text-align:center;">Failed to load.</div>';
    });
}

function markAllRead() {
  fetch('/api/notifications/read', { method:'POST' }).then(() => {
    document.getElementById('notifCount').style.display = 'none';
    document.querySelectorAll('.notif-item.unread').forEach(el => el.classList.remove('unread'));
    showToast('âœ“ All notifications marked as read');
  });
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
{% block extra_js %}{% endblock %}
</body>
</html>
