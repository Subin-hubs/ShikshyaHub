{% extends 'base.html' %}
{% block title %}eSewa Payment â€” ShikshyaHub{% endblock %}
{% block role_label %}Student Portal{% endblock %}
{% block page_title %}eSewa Payment{% endblock %}
{% block sidebar_nav %}
<div class="sidebar-section-label">Overview</div>
<a href="{{ url_for('student_dashboard') }}"><span class="nav-icon">ğŸ </span> Dashboard</a>
<div class="sidebar-section-label">Administration</div>
<a href="{{ url_for('student_notices') }}"><span class="nav-icon">ğŸ“¢</span> Notices</a>
<a href="{{ url_for('student_fees') }}" class="active"><span class="nav-icon">ğŸ’°</span> Fees</a>
<a href="{{ url_for('student_profile') }}"><span class="nav-icon">ğŸ‘¤</span> Profile</a>
{% endblock %}

{% block content %}
<div class="page-header">
  <div><h1>Complete Payment</h1><p>Semester {{ fee.semester }} Fee â€” eSewa Gateway</p></div>
  <a href="{{ url_for('student_fees') }}" class="btn btn-outline">â† Back to Fees</a>
</div>

<div style="max-width:560px;margin:0 auto;">

  <!-- Payment summary card -->
  <div class="card mb-4">
    <div style="background:linear-gradient(135deg,#0f1f3d,#1a2f57);padding:24px;color:#fff;">
      <div style="font-family:'Cormorant Garamond',serif;font-size:1rem;color:rgba(255,255,255,.6);margin-bottom:6px;">Payment Summary</div>
      <div style="font-family:'Cormorant Garamond',serif;font-size:2.2rem;font-weight:700;color:#fff;">Rs. {{ '{:,.0f}'.format(amount_due) }}</div>
      <div style="font-size:.82rem;color:rgba(255,255,255,.6);margin-top:4px;">Semester {{ fee.semester }} outstanding fee</div>
    </div>
    <div class="card-body">
      <div style="display:flex;flex-direction:column;gap:10px;">
        <div style="display:flex;justify-content:space-between;font-size:.875rem;padding:8px 0;border-bottom:1px solid var(--border);">
          <span style="color:var(--text-light);">Total Fee</span>
          <span style="font-weight:700;">Rs. {{ '{:,.0f}'.format(fee.total_fee) }}</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:.875rem;padding:8px 0;border-bottom:1px solid var(--border);">
          <span style="color:var(--text-light);">Already Paid</span>
          <span style="font-weight:700;color:var(--success);">Rs. {{ '{:,.0f}'.format(fee.paid_amount) }}</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:1rem;padding:8px 0;font-weight:800;">
          <span>Amount to Pay</span>
          <span style="color:var(--gold);font-size:1.15rem;">Rs. {{ '{:,.0f}'.format(amount_due) }}</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:.78rem;padding:6px 0;color:var(--text-light);">
          <span>Transaction ID</span>
          <code style="font-size:.75rem;background:var(--bg);padding:2px 8px;border-radius:5px;">{{ txn_id }}</code>
        </div>
      </div>
    </div>
  </div>

  <!-- eSewa payment form -->
  <div class="card mb-4">
    <div class="card-header">
      <span class="card-title" style="display:flex;align-items:center;gap:10px;">
        <span class="esewa-logo" style="font-size:1.2rem;">e<span>Sewa</span></span>
        Pay via eSewa
      </span>
    </div>
    <div class="card-body">
      <div style="background:rgba(96,187,70,.06);border:1.5px solid rgba(96,187,70,.2);border-radius:10px;padding:16px;margin-bottom:20px;">
        <div style="display:flex;gap:10px;align-items:flex-start;">
          <span style="font-size:1.3rem;">ğŸ”’</span>
          <div>
            <div style="font-weight:700;font-size:.875rem;color:var(--navy);margin-bottom:4px;">Secure Payment Gateway</div>
            <div style="font-size:.8rem;color:var(--text-secondary);line-height:1.6;">
              Your payment will be processed securely through eSewa. After payment, you will be redirected back to ShikshyaHub and your fee record will be automatically updated.
            </div>
          </div>
        </div>
      </div>

      <!-- eSewa sandbox form â€” in production replace with live eSewa gateway params -->
      <form action="https://rc-epay.esewa.com.np/api/epay/main/v2/form" method="POST" id="esewaForm">
        <input type="hidden" name="amount" value="{{ amount_due }}">
        <input type="hidden" name="tax_amount" value="0">
        <input type="hidden" name="total_amount" value="{{ amount_due }}">
        <input type="hidden" name="transaction_uuid" value="{{ txn_id }}">
        <input type="hidden" name="product_code" value="EPAYTEST">
        <input type="hidden" name="product_service_charge" value="0">
        <input type="hidden" name="product_delivery_charge" value="0">
        <input type="hidden" name="success_url" value="{{ request.host_url }}student/fees/esewa/success?oid={{ txn_id }}&amt={{ amount_due }}">
        <input type="hidden" name="failure_url" value="{{ request.host_url }}student/fees/esewa/failure?oid={{ txn_id }}">
        <input type="hidden" name="signed_field_names" value="total_amount,transaction_uuid,product_code">
        <input type="hidden" name="signature" value="">

        <button type="submit" class="btn-esewa" style="width:100%;justify-content:center;padding:14px;font-size:1rem;">
          <svg width="22" height="22" viewBox="0 0 40 40" fill="none">
            <circle cx="20" cy="20" r="20" fill="#fff"/>
            <text x="20" y="27" text-anchor="middle" font-size="18" font-weight="900" fill="#60BB46">e</text>
          </svg>
          Pay Rs. {{ '{:,.0f}'.format(amount_due) }} with eSewa
        </button>
      </form>

      <div style="text-align:center;margin:16px 0;color:var(--text-light);font-size:.8rem;">â€” or simulate a payment â€”</div>

      <!-- Simulation button for demo -->
      <a href="{{ url_for('esewa_success') }}?oid={{ txn_id }}&amt={{ amount_due }}&refId=SIM{{ txn_id[-6:] }}"
         class="btn btn-outline" style="width:100%;justify-content:center;text-align:center;">
        ğŸ§ª Simulate Successful Payment (Demo)
      </a>
      <div style="font-size:.72rem;color:var(--text-light);text-align:center;margin-top:8px;">
        âš ï¸ Demo mode â€” In production, use real eSewa gateway credentials
      </div>
    </div>
  </div>

  <!-- Security badges -->
  <div style="display:flex;justify-content:center;gap:16px;flex-wrap:wrap;margin-bottom:24px;">
    <div style="text-align:center;font-size:.72rem;color:var(--text-light);">
      <div style="font-size:1.3rem;margin-bottom:3px;">ğŸ”</div>256-bit SSL
    </div>
    <div style="text-align:center;font-size:.72rem;color:var(--text-light);">
      <div style="font-size:1.3rem;margin-bottom:3px;">ğŸ¦</div>Bank Grade Security
    </div>
    <div style="text-align:center;font-size:.72rem;color:var(--text-light);">
      <div style="font-size:1.3rem;margin-bottom:3px;">ğŸ“±</div>eSewa Certified
    </div>
    <div style="text-align:center;font-size:.72rem;color:var(--text-light);">
      <div style="font-size:1.3rem;margin-bottom:3px;">âœ…</div>Instant Receipt
    </div>
  </div>
</div>
{% endblock %}
